# Архитектура боевого геймплея

Этот документ описывает двухуровневую архитектуру для обработки боевых сессий.

## Обзор

Архитектура разделена на два уровня:
1.  **Глобальный уровень:** Отвечает за общие сервисы (матчмейкинг, профили).
2.  **Локальный уровень (Зона):** Изолированное окружение для проведения множества матчей, управляемое собственным оркестратором.

---

## 1. Глобальный уровень

Здесь работает **Центральный Матчмейкинг Сервис**.

**Задачи:**
-   Принимает запросы от игроков на поиск матча.
-   Формирует команды.
-   Взаимодействует с **Локальными Оркестраторами**, чтобы найти свободное место в существующей **Зоне**.
-   Возвращает игрокам адрес для подключения к `WebSocket Service` конкретной Зоны.

---

## 2. Локальный уровень (Зона)

Каждая **Зона** — это долгоживущее, изолированное окружение, способное одновременно проводить **несколько матчей**.

**Ключевые свойства:**
-   **Долговечность:** Зона работает постоянно, а не создается под каждый матч.
-   **Мульти-матчевость:** Одна Зона обслуживает множество параллельных игровых симуляций.
-   **Масштабируемость:** Можно запускать несколько Зон на разных физических серверах.

### Компоненты Зоны:

#### а) Локальный Оркестратор (`Local Orchestrator`)
-   **Назначение:** "Мозг" и точка входа в Зону.
-   **Роль:**
    1.  Взаимодействует с Центральным Матчмейкингом.
    2.  Ведет учет всех подключенных к Зоне игроков.
    3.  Хранит `Map` с запущенными инстансами игровых симуляций и списком игроков в каждой.
    4.  Принимает решение о запуске нового `Gameplay Service`, если текущие переполнены.
    5.  Маршрутизирует `PlayerInput` от игроков к нужному инстансу симуляции.

#### б) Кластер NATS
-   **Назначение:** Единая шина данных для всей Зоны.
-   **Роль:** Обеспечивает асинхронное взаимодействие между всеми сервисами *внутри* Зоны.

#### в) WebSocket Service
-   **Назначение:** Единая точка входа для всех игроков, подключенных к этой Зоне.
-   **Роль:**
    1.  Принимает WebSocket-соединения.
    2.  Передает `PlayerInput` от игрока в NATS (с указанием ID игрока).
    3.  Подписывается на `WorldState` из NATS (для всех матчей в Зоне).
    4.  Отправляет каждому игроку только тот `WorldState`, который относится к его матчу.

#### г) Gameplay Service(s)
-   **Назначение:** Вычислительный узел, который запускает симуляции.
-   **Роль:**
    1.  Внутри себя содержит `Map`, где ключ — `match_id`, а значение — **инстанс игровой симуляции** (`GameLoop`).
    2.  Может одновременно симулировать **несколько матчей**.
    3.  Подписывается на `PlayerInput` из NATS и передает их в соответствующий `GameLoop` по `match_id`.
    4.  Публикует `WorldState` каждого матча в NATS (с указанием `match_id`).

---

## Схема взаимодействия

1.  **Игрок** ищет игру через **Центральный Матчмейкинг**.
2.  **Матчмейкинг** находит подходящую **Зону** через ее **Локальный Оркестратор**.
3.  **Локальный Оркестратор** определяет, в какой `Gameplay Service` и в какой инстанс симуляции поместить игроков. Если нужно, он может запросить запуск нового `Gameplay Service`.
4.  Игрокам возвращается адрес **`WebSocket Service`** этой Зоны.
5.  Игроки подключаются. `PlayerInput` через NATS попадает в **Локальный Оркестратор**, который перенаправляет его в нужный `Gameplay Service` и нужный `GameLoop`.
6.  `Gameplay Service` генерирует `WorldState` и отправляет его в NATS.
7.  `WebSocket Service` получает `WorldState` и отправляет его только тем игрокам, которые находятся в этом матче.
