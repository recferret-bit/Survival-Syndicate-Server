# NATS: Контракт отчетов от Локального Оркестратора

Этот документ описывает NATS-контракт, по которому каждый `Local Orchestrator` периодически сообщает о своем общем состоянии **Центральному Матчмейкинг Сервису**.

## Назначение

Чтобы `Matchmaking Service` мог эффективно распределять группы игроков по разным **Зонам**, ему необходимо знать, насколько каждая Зона загружена и есть ли в ней свободные места. Этот контракт предоставляет Матчмейкеру всю необходимую информацию для принятия решений.

---

## Контракт

### Тема: `orchestrator.zone.heartbeat`

-   **Назначение:** Периодическая отправка "пульса" от каждого `Local Orchestrator`, представляющего свою Зону.
-   **Частота:** Рекомендуется отправлять каждые 5-10 секунд.
-   **Тип:** Fire-and-forget.

### Payload (Структура сообщения)

Сообщение представляет собой JSON-объект следующей структуры:

```json
{
  "zoneId": "string",
  "region": "string",
  "maxPlayers": "number",
  "activePlayers": "number",
  "activeMatches": "number",
  "isAcceptingNewMatches": "boolean",
  "publicHost": "string",
  "publicPort": "number"
}
```

**Описание полей:**

-   **`zoneId` (string):**
    Уникальный идентификатор Зоны (например, `eu-central-1-zone-a`).

-   **`region` (string):**
    Географический регион, в котором расположена Зона (например, `eu-central-1`). Помогает Матчмейкеру подбирать сервер с наименьшим пингом.

-   **`maxPlayers` (number):**
    Максимальное количество игроков, которое может одновременно обслуживать эта Зона.

-   **`activePlayers` (number):**
    Текущее количество игроков во всех матчах этой Зоны.

-   **`activeMatches` (number):**
    Текущее количество активных матчей в Зоне.

-   **`isAcceptingNewMatches` (boolean):**
    Флаг, показывающий, готова ли Зона принимать новые матчи. Оркестратор может выставить `false`, если Зона близка к перегрузке или находится в процессе обслуживания.

-   **`publicHost` (string):**
    Публичный IP-адрес или доменное имя `WebSocket Service` этой Зоны.

-   **`publicPort` (number):**
    Публичный порт `WebSocket Service`.

---

## Схема взаимодействия

1.  Каждый `Local Orchestrator` каждые N секунд собирает агрегированную информацию о своей Зоне (количество игроков, матчей, статус).
2.  Он формирует JSON-сообщение и публикует его в глобальную тему `orchestrator.zone.heartbeat`.
3.  `Matchmaking Service` подписан на эту тему.
4.  При получении сообщения, Матчмейкер обновляет свою внутреннюю таблицу доступных Зон и их текущей нагрузки.
5.  Когда приходит запрос на поиск игры, Матчмейкер использует эту таблицу, чтобы выбрать наиболее подходящую Зону (свободную и близкую к игрокам).
