# 35. Стратегии защиты от DDoS-атак

Защита от DDoS — это многоуровневая задача, которая решается и на уровне инфраструктуры, и на уровне кода.

## 1. Уровень инфраструктуры (Самый важный)

99% защиты от объемных DDoS-атак (L3/L4) должно происходить **до того**, как трафик вообще достигнет наших VPS.

-   **Cloud Provider Protection:** Все крупные облачные провайдеры (Яндекс.Облако, AWS, Google Cloud) предоставляют встроенную защиту от DDoS. Это первая и главная линия обороны.
-   **Проксирование трафика (Cloudflare/Arbor):** Для критически важных эндпоинтов (сайт, API матчмейкинга) можно использовать специализированные сервисы, которые фильтруют трафик еще до того, как он попадает в сеть нашего провайдера.
-   **Изоляция сетей:** Ваша архитектура с **внутренней (приватной) сетью** для доступа к базам данных — это уже элемент защиты. Даже если игровой сервер будет под атакой, злоумышленник не сможет получить прямой доступ к БД.

## 2. Уровень кода (Защита от атак на приложение, L7)

### 2.1. Для REST API (Матчмейкинг, Лобби)

-   **Rate Limiting (Ограничение частоты запросов):** Это **обязательная** мера.
    -   **Реализация:** Используем middleware в Node.js (например, `express-rate-limit`).
    -   **Стратегия:** Ограничиваем количество запросов с одного IP-адреса. Например, не более 100 запросов в минуту на эндпоинт `/matchmaking/find`. Это защитит от простого флуда.
-   **Валидация запросов:** Всегда проверять входящие данные. Запрос с невалидным `jwt_token` или некорректной структурой JSON должен отсекаться немедленно.
-   **"Тяжелые" запросы:** Если есть ресурсоемкие запросы (например, просмотр истории матчей с пагинацией), на них нужно ставить более строгие лимиты.

### 2.2. Для WebSocket Gateway

-   **Токен аутентификации:** Ваша идея с **одноразовым токеном**, который `Matchmaking Service` выдает для подключения к матчу, — это отличная защита. WebSocket Gateway должен принимать соединение **только** от клиента с валидным, свежим токеном. Попытки подключения без токена или с невалидным — немедленно обрываются.
-   **Лимит на размер пакета:** Установить максимальный размер одного WebSocket-сообщения. Это защитит от атак, пытающихся исчерпать память сервера, отправляя гигабайтные пакеты.
-   **Rate Limiting на уровне сообщений:** Если клиент начинает слать `PLAYER_INPUT` не 20 раз в секунду, а 2000, Gateway должен временно или перманентно его отключить.
-   **Разделение серверов:** Ваша архитектура, где WebSocket Gateway — это отдельный stateless-сервис, идеальна. DDoS-атака на Gateway одного региона не затронет игроков в другом регионе и не положит игровую логику, так как `Game Server`'ы изолированы.
