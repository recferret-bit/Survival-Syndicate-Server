# Поток создания нового пользователя

Этот документ описывает процесс регистрации нового пользователя с использованием широковещательного, надежного события NATS.

## Принцип: "Choreography" (Хореография)

Вместо того чтобы один сервис (например, `Auth Service`) поочередно вызывал все остальные сервисы для создания связанных данных, мы используем паттерн "хореографии".

`Auth Service` просто объявляет факт: "Зарегистрирован новый пользователь". А все остальные заинтересованные сервисы самостоятельно реагируют на это событие и выполняют свою часть работы. Это делает систему более гибкой и менее связанной.

---

## 1. NATS Событие: `user.registered`

Это "сердце" всего процесса.

-   **Тема:** `user.registered`
-   **Тип:** **Broadcast (широковещательное).** Сообщение получают все, кто на него подписан.
-   **Надежность (Reliable):** Используется **NATS JetStream**. Это гарантирует, что даже если сервис-подписчик был временно недоступен, он получит сообщение, как только вернется в онлайн.

### Payload (Структура события)

```json
{
  "userId": "string",
  "username": "string",
  "email": "string",
  "registrationTimestamp": "ISO_datetime"
}
```

-   **`userId`:** Уникальный ID нового пользователя, сгенерированный `Auth Service`.
-   **`username`**, **`email`:** Регистрационные данные.

---

## 2. Сервисы-подписчики

Несколько сервисов подписываются на тему `user.registered` и выполняют свою работу параллельно и независимо.

### а) `Player Service`
-   **Задача:** Создать базовую запись об игроке.
-   **Действие:** При получении события создает в своей базе данных запись `Player` с `userId` и `username`.

### б) `Character Service`
-   **Задача:** Создать для игрока персонажа по умолчанию.
-   **Действие:**
    1.  Создает в своей БД запись `Character` (например, "Recruit" или "Slick Sam").
    2.  Привязывает этого персонажа к `userId`.
    3.  Устанавливает этого персонажа как "активного" по умолчанию.

### в) `Meta Progression Service`
-   **Задача:** Создать дефолтную мета-прогрессию.
-   **Действие:**
    1.  Создает в своей БД запись о прогрессии для `userId`.
    2.  Заполняет ее начальными данными: разблокирует стартовое оружие (пистолет), стартовые скиллы.

### г) `Building Service`
-   **Задача:** Создать набор зданий по умолчанию для режима "базы".
-   **Действие:**
    1.  Создает в своей БД записи о базовых зданиях (например, "Штаб 1-го уровня", "Склад 1-го уровня").
    2.  Привязывает их к `userId`.

---

## Полная схема

1.  Пользователь регистрируется через `Auth Service` (например, через `POST /api/auth/register`).
2.  `Auth Service` создает запись о пользователе в своей БД.
3.  `Auth Service` немедленно публикует событие `user.registered` в NATS JetStream.
4.  `Player Service`, `Character Service`, `Meta Progression Service` и `Building Service` **одновременно** получают это событие.
5.  Каждый из них независимо выполняет свою логику, создавая необходимые данные, связанные с новым `userId`.
