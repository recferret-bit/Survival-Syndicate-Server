# Обработка подключения, дисконнекта и реконнекта

Этот документ описывает полный жизненный цикл соединения: первое подключение (новый игрок), потерю связи и возвращение в игру.

## Основные инварианты

-   **Неизменяемость слота:** Слот матча жёстко привязан к `playerId` с момента создания матча. Эта привязка не изменяется никогда. Другой игрок не может занять чужой слот.
-   **Сохранение состояния:** Игрок не "удаляется" из матча сразу после дисконнекта. Сервер резервирует за ним слот на `GRACE_PERIOD` (60 сек).
-   **Безопасный реконнект:** Вернувшийся игрок подтверждает личность через JWT, а Оркестратор проверяет соответствие `playerId` слоту.
-   **Быстрое восстановление:** После реконнекта игрок немедленно получает полный `WorldState`, чтобы продолжить игру.

---

## 0. Первое подключение (новый игрок)

Флоу запускается при получении `client.authenticate`.

1.  `WebSocket Service` валидирует JWT, извлекает `playerId`.
2.  Через NATS запрашивает `Local Orchestrator`: "есть ли активный матч, в котором `playerId` записан в слот"?
3.  Оркестратор вернёт `matchId` и подтверждает слот. Если нет — отказ в подключении.
4.  Оркестратор устанавливает `SlotStatus = 'active'` для этого `playerId`.
5.  `WebSocket Service` отправляет клиенту `server.authenticate.success`.
6.  Публикует `player.connection.status { status: "connected", playerId, matchId }`.

---

## 1. Логика на стороне WebSocket Service

#### Обнаружение дисконнекта
-   `WebSocket Service` обнаруживает разрыв соединения (событие `on:close` сокета).
-   Он **не удаляет** информацию об игроке, а лишь помечает его как `disconnected`.
-   Рассылает `server.match.player_disconnected` всем остальным игрокам того же матча.
-   Публикует `player.connection.status { status: "disconnected", playerId, matchId }` в NATS.

#### NATS Publication (при дисконнекте)

-   **Тема:** `player.connection.status`
-   **Payload:**
    ```json
    {
      "playerId": "string",
      "matchId": "string",
      "status": "disconnected"
    }
    ```

---

## 2. Логика на стороне Local Orchestrator

-   **Таймер "Grace Period":**
    -   Оркестратор слушает события `player.connection.status`.
    -   Получив `status: "disconnected"`, он запускает для этого игрока таймер (например, на 60 секунд).
    -   Если за это время игрок не вернется, Оркестратор отправит команду в `Gameplay Service` на окончательное удаление игрока из матча.

---

## 3. Процесс реконнекта (со стороны клиента)

1.  Клиент обнаруживает разрыв соединения.
2.  Он пытается переподключиться к тому же `websocketUrl`, который получил от Матчмейкера.
3.  **Сразу после подключения** он отправляет **новое** аутентификационное сообщение.

### WebSocket: `client.reconnect` (Клиент -> Сервер)

-   **Назначение:** Попытка вернуться в существующий матч. **Должно быть первым сообщением** при переподключении.
-   **Payload:**
    ```json
    {
      "type": "reconnect",
      "token": "string" 
    }
    ```
    -   `token`: Тот же самый `accessToken` (JWT), который использовался для входа.

---

## 4. Логика на стороне WebSocket Service (при реконнекте)

1.  Сервис получает сообщение `client.reconnect`.
2.  Он валидирует JWT, извлекает `playerId`.
3.  Через NATS он обращается к `Local Orchestrator` с запросом.

### NATS Request (WebSocket -> Оркестратор)

-   **Тема:** `orchestrator.player.reconnect_request`
-   **Payload:**
    ```json
    {
      "playerId": "string"
    }
    ```

### Логика Оркестратора (ответ на запрос)

Оркестратор проверяет по порядку:

1.  `playerId` известен оркестратору (есть в `Map<matchId, Map<playerId, SlotStatus>>`)?
2.  `SlotStatus` для этого `playerId` равен `'disconnected'`?
3.  Таймер grace period ещё не истёк?
4.  **[CRITICAL]** `playerId` из JWT совпадает с `playerId`, который изначально был записан в этот слот матча?

-   **Если все 4 проверки пройдены:**
    -   Оркестратор останавливает таймер на удаление, устанавливает `SlotStatus = 'active'`.
    -   Отвечает `WebSocket Service` успехом с `matchId`.
-   **Если проверка 4 провалилась** (другой `playerId`):
    -   Возвращает ошибку `SLOT_NOT_AVAILABLE`. Слот не изменяется.
-   **Если проверка 2 или 3 провалилась:**
    -   Возвращает ошибку `GRACE_EXPIRED` или `MATCH_NOT_FOUND`.

### Финальные шаги

-   Получив успех от Оркестратора, `WebSocket Service` отправляет клиенту `server.reconnect.success` (включая полный `WorldState`) и начинает обычный обмен `WorldState`.
-   Рассылает `server.match.player_reconnected` всем остальным игрокам матча.
-   Публикует `player.connection.status { status: "reconnected", playerId, matchId }` в NATS.
-   Если реконнект отклонён: отправляет клиенту `server.reconnect.error` с кодом ошибки и закрывает WS-соединение.
