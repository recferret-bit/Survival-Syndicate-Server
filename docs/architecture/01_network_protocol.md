# 25. Сетевой протокол WebSocket (v6 - Восстановленная)

## 1. Общие принципы

-   **Транспорт:** WebSocket.
-   **Формат данных:** JSON. Каждое сообщение — это JSON-объект с полем `type`.
-   **Периодичность:**
    -   **Клиент -> Сервер (Input):** ~20 раз в секунду (каждые 50 мс).
    -   **Сервер -> Клиент (State Sync):** ~10 раз в секунду (каждые 100 мс).

## 2. Жизненный цикл сессии

1.  Клиент устанавливает WebSocket соединение.
2.  Клиент отправляет `AUTH` с токеном.
3.  Сервер проверяет токен и отправляет `JOIN_SUCCESS` с начальным состоянием мира.
4.  Начинается обмен `PLAYER_INPUT` и `WORLD_STATE`.
5.  По завершении матча сервер отправляет `MATCH_END`.

---

## 3. Сообщения: Клиент -> Сервер

### `AUTH` (Аутентификация)
-   **Когда:** Сразу после установки соединения.
-   **Поля:**
    -   `type: "AUTH"`
    -   `match_id: "..."`
    -   `token: "one-time-match-token"`

### `PLAYER_INPUT` (Ввод игрока)
-   **Поля:**
    -   `type: "PLAYER_INPUT"`
    -   `sequence_id: 123`
    -   `client_time: 1678886400050` (timestamp клиента для Lag Compensation)
    -   `ping: 80` (RTT в мс, измеряемый клиентом)
    -   `joystick_vector: {x: 0.8, y: -0.2}` (Состояние виртуального джойстика)
    -   `actions: []` (мгновенные действия)
    -   `states: {}` (длительные состояния)

#### Поле `actions` (Очередь)
-   Массив событий, произошедших с последнего тика. Очищается после отправки.
-   **Пример:** `{"type": "USE_SLOT", "slot_index": 2}`

#### Поле `states` (Снимок)
-   Объект, описывающий текущие зажатые состояния.
-   **Пример:** `{"is_firing": true}`

## 4. Частота и логика отправки `PLAYER_INPUT`

`PLAYER_INPUT` — это **снимок состояния (snapshot)** ввода игрока.

-   **Частота:** Клиент отправляет этот пакет с **фиксированной частотой** (20 раз в секунду), независимо от действий игрока.
-   **Логика полей:**
    -   **`joystick_vector` и `states`:** Всегда содержат **текущее, мгновенное состояние** в момент отправки.
    -   **`actions`:** Это **очередь событий**, которые произошли **с момента отправки предыдущего пакета**.

---

## 5. Сообщения: Сервер -> Клиент

### `JOIN_SUCCESS` (Успешное подключение)
-   **Когда:** В ответ на успешную `AUTH`.
-   **Поля:**
    -   `type: "JOIN_SUCCESS"`
    -   `player_id: "..."`
    -   `initial_state: { ... }` (полный объект `WORLD_STATE`)

### `WORLD_STATE` (Синхронизация состояния мира)
-   **Когда:** Постоянно во время матча (в виде `deltaState`).
-   **Периодичность:** ~10 раз/сек (каждые 100 мс).
-   **Поля:**
    -   `type: "WORLD_STATE"`
    -   `server_time: 1678886400123`
    -   `players: { "player_id": { "position": ... } }` (Объект с измененными данными)
    -   `enemies: { "enemy_id": { "health": ... } }`
    -   `events: [ ... ]`

#### Поле `events`
-   Массив событий, произошедших с последней отправки.
-   **Примеры:** `{"type": "DAMAGE", ...}`, `{"type": "DEATH", ...}`, `{"type": "PLAY_SOUND", ...}`

### `MATCH_END` (Конец матча)
-   **Когда:** По завершении матча.
-   **Поля:**
    -   `type: "MATCH_END"`
    -   `reason: "VICTORY" | "DEFEAT"`
    -   `stats: { ... }`
