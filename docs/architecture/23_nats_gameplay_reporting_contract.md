# NATS: Контракт отчетов от Gameplay Service

Этот документ описывает NATS-контракт, по которому каждый `Gameplay Service` периодически отправляет сводку о своем состоянии в `Local Orchestrator` в рамках одной Зоны.

## Назначение

`Local Orchestrator` должен знать, насколько загружен каждый `Gameplay Service`, чтобы принимать решения о размещении новых матчей или запуске новых инстансов сервиса. Этот контракт обеспечивает Оркестратор необходимой информацией.

---

## Контракт

### Тема: `gameplay.service.heartbeat`

-   **Назначение:** Периодическая отправка "пульса" от каждого `Gameplay Service`.
-   **Частота:** Рекомендуется отправлять каждые 5-10 секунд.
-   **Тип:** Fire-and-forget (Оркестратор не отвечает на это сообщение).

### Payload (Структура сообщения)

Сообщение представляет собой JSON-объект следующей структуры:

```json
{
  "serviceId": "string",
  "maxInstances": "number",
  "activeInstances": "number",
  "activePlayers": "number",
  "cpuLoad": "number",
  "memoryUsage": "number"
}
```

**Описание полей:**

-   **`serviceId` (string):**
    Уникальный идентификатор инстанса `Gameplay Service` (например, ID контейнера или сгенерированный UUID).

-   **`maxInstances` (number):**
    Максимальное количество игровых симуляций (`GameSimulation`), которое может одновременно работать на этом инстансе сервиса. Это значение обычно берется из конфигурации.

-   **`activeInstances` (number):**
    Количество активных симуляций в данный момент.

-   **`activePlayers` (number):**
    Общее количество игроков, обслуживаемых этим инстансом `Gameplay Service` во всех симуляциях.

-   **`cpuLoad` (number, опционально):**
    Средняя загрузка CPU процессом `Gameplay Service` в процентах. Позволяет Оркестратору принимать более "умные" решения о масштабировании.

-   **`memoryUsage` (number, опционально):**
    Использование памяти процессом в мегабайтах.

---

## Схема взаимодействия

1.  Каждый `Gameplay Service` при старте запускает таймер, который каждые N секунд вызывает функцию `reportStatus()`.
2.  Функция `reportStatus()` собирает актуальные метрики (количество симуляций, игроков, нагрузку) и формирует JSON-сообщение.
3.  `Gameplay Service` публикует это сообщение в тему `gameplay.service.heartbeat`.
4.  `Local Orchestrator` подписан на эту тему (`gameplay.service.heartbeat`).
5.  При получении сообщения, Оркестратор обновляет свою внутреннюю таблицу состояний всех `Gameplay` сервисов в его Зоне.
