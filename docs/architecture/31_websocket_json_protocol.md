# WebSocket: Детальный JSON протокол

Этот документ описывает детальные JSON-структуры для сообщений `PlayerInput` (клиент -> сервер) и `WorldState` (сервер -> клиент), используемых в WebSocket-протоколе.

Все сообщения являются JSON-строками. Каждое сообщение имеет поле `type`, чтобы сервер и клиент могли различать их.

---

## 1. `PlayerInput` (Клиент -> Сервер)

-   **Назначение:** Содержит всю информацию о действиях игрока за один кадр (тик).
-   **`type`:** `"input"`

### Структура

```json
{
  "type": "input",
  "sequenceNumber": 123,
  "movement": {
    "x": -1,
    "y": 0
  },
  "aimAngle": 1.57,
  "actions": [
    "shoot",
    "reload"
  ]
}
```

### Описание полей

-   **`sequenceNumber` (number):**
    Порядковый номер этого пакета ввода. Увеличивается на 1 с каждым отправленным пакетом. Критически важен для механизма **Client-Side Prediction и Reconciliation**.

-   **`movement` (object):**
    Нормализованный вектор движения.
    -   `x`, `y`: Значения от -1 до 1. Например, `{"x": -1, "y": 0}` означает движение влево. `{"x": 0, "y": 0}` — нет движения.

-   **`aimAngle` (number):**
    Угол прицеливания в радианах.

-   **`actions` (array of strings, опционально):**
    Массив "одноразовых" действий, совершенных в этом тике.
    -   Возможные значения: `"shoot"`, `"reload"`, `"use_skill_1"`, и т.д.
    -   Поле может отсутствовать, если действий не было.

---

## 2. `WorldState` (Сервер -> Клиент)

-   **Назначение:** Полный "снимок" состояния игрового мира в определенный момент времени (тик).
-   **`type`:** `"state"`

### Структура

```json
{
  "type": "state",
  "serverTick": 4560,
  "lastProcessedInput": 123,
  "entities": [
    {
      "id": "player_1",
      "type": "player",
      "position": { "x": 100.5, "y": 250.0 },
      "health": 95
    },
    {
      "id": "enemy_alpha",
      "type": "melee_guard",
      "position": { "x": 150.0, "y": 280.0 },
      "health": 100
    }
  ],
  "events": [
    {
      "type": "player_damage",
      "playerId": "player_1",
      "damage": 5,
      "sourceId": "enemy_alpha"
    }
  ]
}
```

### Описание полей

-   **`serverTick` (number):**
    Номер тика на сервере, которому соответствует это состояние.

-   **`lastProcessedInput` (number):**
    `sequenceNumber` последнего `PlayerInput` от этого клиента, который был учтен при расчете этого `WorldState`. Ключевое поле для **Reconciliation**.

-   **`entities` (array of objects):**
    Массив состояний всех игровых сущностей.
    -   `id` (string): Уникальный ID сущности.
    -   `type` (string): Тип сущности (`player`, `melee_guard`, `bullet`, и т.д.). Позволяет клиенту понять, как отрисовывать объект.
    -   `position` (object): Координаты `x`, `y`.
    -   ...другие поля, специфичные для сущности (здоровье, анимация, и т.д.).

-   **`events` (array of objects, опционально):**
    Массив "одноразовых" событий, которые произошли в этом тике. Это звуки, эффекты, которые не являются постоянным состоянием.
    -   `type` (string): Тип события (`player_damage`, `enemy_death`, `shot_fired`).
    -   ...другие поля, зависящие от типа события.
    -   Клиент обрабатывает эти события один раз и не хранит их.
