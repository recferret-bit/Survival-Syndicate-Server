# WebSocket: Детальный JSON протокол (с компенсацией лага)

Этот документ описывает детальные JSON-структуры для сообщений, используемых в WebSocket-протоколе, с учетом механизмов компенсации задержки, сверки, интерполяции и дельта-компрессии.

---

## 1. `PlayerInput` (Клиент -> Сервер)

-   **`type`:** `"input"`

### Структура

```json
{
  "type": "input",
  "clientTimestamp": 1676738787123,
  "sequenceNumber": 123,
  "movement": { "x": -1, "y": 0 },
  "aimAngle": 1.57,
  "actions": ["shoot"]
}
```

### Новые и измененные поля

-   **`clientTimestamp` (number, **новое**):**
    Время отправки пакета по локальным часам клиента (в миллисекундах, `Date.now()`). **Критически важно для компенсации лага (Lag Compensation)**. Сервер будет использовать это время, чтобы "отмотать" состояние мира назад и проверить, например, выстрел, в том положении, в котором враги были на экране у игрока в момент выстрела.

---

## 2. `WorldState` (Сервер -> Клиент)

-   **`type`:** `"state"`

### Структура

```json
{
  "type": "state",
  "serverTick": 4560,
  "serverTimestamp": 1676738787223,
  "lastProcessedInput": 123,
  "entities_full": [
    {
      "id": "player_1",
      "type": "player",
      "position": { "x": 100.5, "y": 250.0 },
      "health": 95
    }
  ],
  "entities_delta": [
    {
      "id": "enemy_alpha",
      "p": { "x": 150.1, "y": 280.5 }
    }
  ],
  "entities_removed": ["enemy_bravo"],
  "events": [
    {
      "type": "player_damage",
      "playerId": "player_1",
      "damage": 5
    }
  ]
}
```

### Новые и измененные поля

-   **`serverTimestamp` (number, **новое**):**
    Время генерации этого состояния на сервере. **Критически важно для интерполяции (Entity Interpolation)**. Клиент использует временные метки двух последовательных состояний, чтобы плавно отрисовывать движение объектов между ними.

-   **`entities_full` (array, **изменено**):**
    Массив **полных** состояний сущностей. Отправляется редко (например, раз в несколько секунд) или для только что появившихся на экране объектов. Содержит все поля.

-   **`entities_delta` (array, **новое**):**
    Массив **частичных** обновлений для сущностей, которые уже есть у клиента. Это основа **дельта-компрессии**.
    -   `id`: Обязательное поле, чтобы клиент знал, какую сущность обновить.
    -   Остальные поля — только те, что изменились с последнего `WorldState`. Например, `p` вместо `position` для экономии трафика. Клиент должен "склеить" эти изменения со своим последним известным состоянием этой сущности.

-   **`entities_removed` (array of strings, **новое**):**
    Массив ID сущностей, которые были удалены из мира (убиты, исчезли). Позволяет клиенту не ждать, пока объект "пропадет" из `entities_full`, а удалять его немедленно.

---

**`lastProcessedInput`** по-прежнему используется для **сверки (Reconciliation)** на стороне клиента.
