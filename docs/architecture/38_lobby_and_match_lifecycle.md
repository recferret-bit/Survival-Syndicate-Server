# Флоу: Лобби и жизненный цикл матча

Этот документ описывает процесс начала игры, от выбора режима до старта матча.

## 1. Выбор типа игры (на клиенте)

Перед поиском игры пользователь выбирает один из двух режимов:
-   **"Соло":** Игра начинается немедленно.
-   **"В группе":** Создается лобби для ожидания других игроков.

---

## 2. Флоу "Соло" игры

1.  Клиент отправляет запрос на специальный эндпоинт.
2.  `Matchmaking Service` немедленно ищет доступную Зону.
3.  Игроку сразу возвращается `websocketUrl` для подключения.

**Это, по сути, "короткий путь" существующего флоу.**

---

## 3. Флоу "В группе" (Лобби)

Этот флоу вводит новую сущность — **Лобби**, которой управляет `Matchmaking Service`.

### Жизненный цикл лобби:

1.  **Создание:** Игрок-хост создает лобби. Ему возвращается `lobbyId`.
2.  **Присоединение:** Другие игроки присоединяются к лобби по `lobbyId` (через инвайт-ссылку или из списка друзей).
3.  **Ожидание:** Игроки находятся в лобби. Их состояние (кто в сети, кто нажал "Готов") синхронизируется в реальном времени через WebSocket.
4.  **Выход:** Игрок может покинуть лобби.
5.  **Старт матча:** Когда все игроки нажали "Готов", хост может запустить игру. `Matchmaking Service` запускает стандартный процесс поиска Зоны и передает игроков в `Local Orchestrator`. С этого момента лобби считается "закрытым", и новые игроки в него (и в сам матч) войти не могут.

### Протокол взаимодействия:

#### HTTP API (для управления лобби)

-   `POST /api/lobbies/create` -> Создает лобби, возвращает `lobbyId`.
-   `POST /api/lobbies/{lobbyId}/join` -> Присоединиться к лобби.
-   `DELETE /api/lobbies/{lobbyId}/leave` -> Покинуть лобби.
-   `POST /api/lobbies/{lobbyId}/start` -> (Только для хоста) Запускает поиск матча, если все готовы.

#### WebSocket (для синхронизации состояния лобби)

После присоединения к лобби, клиент устанавливает WebSocket-соединение для получения обновлений.

**Сообщения (Клиент -> Сервер):**

-   **`client.lobby.set_ready`:**
    ```json
    { "type": "lobby_set_ready", "isReady": true }
    ```
    (Игрок нажал кнопку "Готов" / "Не готов").

**Сообщения (Сервер -> Клиент):**

-   **`server.lobby.state_update`:**
    ```json
    {
      "type": "lobby_state_update",
      "lobbyId": "string",
      "hostId": "string",
      "players": [
        { "playerId": "p1", "username": "PlayerOne", "isReady": true },
        { "playerId": "p2", "username": "PlayerTwo", "isReady": false }
      ]
    }
    ```
    (Отправляется всем участникам лобби при любом изменении: кто-то вошел, вышел, изменил статус готовности).
