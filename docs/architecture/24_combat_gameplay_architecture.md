# Архитектура боевого геймплея

Этот документ описывает двухуровневую архитектуру, спроектированную для обработки боевых сессий (матчей) в игре.

## Обзор

Архитектура разделена на два основных уровня:
1.  **Глобальный уровень:** Отвечает за общие сервисы, доступные всем игрокам (матчмейкинг, аутентификация, профили игроков).
2.  **Локальный уровень (матч):** Изолированное окружение, которое создается для проведения одного конкретного матча и уничтожается после его завершения.

---

## 1. Глобальный уровень

На этом уровне работает **центральный сервис матчмейкинга (`Matchmaking Service`)**.

**Задачи:**
-   Принимает запросы от игроков на поиск матча.
-   Формирует команды на основе рейтинга и других параметров.
-   Взаимодействует с **Оркестратором** для получения или создания свободной **Локальной Группы** для проведения матча.
-   Возвращает игрокам сетевые реквизиты (IP, порт, токен матча) для прямого подключения к Локальной Группе.

---

## 2. Локальный уровень (Локальная Группа)

Каждый матч проходит в изолированном, независимом окружении, называемом **Локальная Группа**. Это группа из нескольких микросервисов, работающих вместе.

**Ключевые свойства:**
-   **Динамичность:** Группа создается по требованию и уничтожается после матча.
-   **Изоляция:** Сбой в одной группе не влияет на другие матчи.
-   **Масштабируемость:** Оркестратор может запускать сотни таких групп на разных физических серверах.

### Компоненты Локальной Группы:

#### а) Mini NATS Cluster
-   **Назначение:** Собственный изолированный брокер сообщений для данной группы.
-   **Роль:** Обеспечивает асинхронное взаимодействие между сервисами *внутри* группы. Это исключает необходимость сервисам знать прямые адреса друг друга.

#### б) WebSocket Service
-   **Назначение:** Точка входа для игроков, подключенных к этому матчу.
-   **Роль:**
    1.  Принимает WebSocket-соединения от клиентов.
    2.  Получает от них сообщения `PlayerInput`.
    3.  Публикует эти сообщения в локальный NATS.
    4.  Подписывается на события `WorldState` из NATS.
    5.  Рассылает полученные `WorldState` всем игрокам в матче.

#### в) Gameplay Service(s)
-   **Назначение:** Ядро симуляции матча. Здесь работает основной `GameLoop`.
-   **Роль:**
    1.  Подписывается на сообщения `PlayerInput` из NATS.
    2.  Обрабатывает ввод игроков, симулирует физику, AI, логику боя.
    3.  На каждом тике генерирует актуальный `WorldState`.
    4.  Публикует `WorldState` в локальный NATS.
    5.  После окончания матча публикует событие `MatchFinished`, на которое реагирует Оркестратор.

---

## Схема взаимодействия

1.  **Игрок** отправляет запрос "Найти игру" на глобальный API.
2.  **Matchmaking Service** подбирает оппонентов и запрашивает у **Оркестратора** новую Локальную Группу.
3.  **Оркестратор** запускает необходимый набор контейнеров (WebSocket, Gameplay, NATS) для новой группы.
4.  **Matchmaking Service** получает от Оркестратора адрес `WebSocket Service` и передает его игрокам.
5.  **Игроки** напрямую подключаются к `WebSocket Service` своей Локальной Группы.
6.  **Внутри матча:** `PlayerInput` от игроков идет по цепочке `WebSocket Service -> NATS -> Gameplay Service`.
7.  **Состояние мира:** `WorldState` идет по обратной цепочке `Gameplay Service -> NATS -> WebSocket Service -> Игроки`.
8.  **Матч завершен:** `Gameplay Service` отправляет сообщение в NATS, Оркестратор получает его и уничтожает всю Локальную Группу.
